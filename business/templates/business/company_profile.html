{% extends "business/base.html" %}
{% load static %}

{% block title %}{{ company.name }} | U-Connect{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Company Header -->
    <div class="company-header-card mb-4">
        <div class="card-body p-3 p-md-4">
            <div class="d-flex flex-column flex-md-row align-items-center">
                <div class="me-md-4 mb-3 mb-md-0">
                    {% if company.logo %}
                        <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="company-logo-large">
                    {% else %}
                        <div class="company-logo-placeholder">
                            <i class="bi bi-building" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="text-center text-md-start flex-grow-1">
                    <h1 class="fw-bold mb-2">
                        {{ company.name }}
                        {% if company.is_verified %}
                            <i class="bi bi-patch-check-fill verified-badge" title="Verified Company"></i>
                        {% endif %}
                    </h1>
                    {% if company.description %}
                        <p class="text-muted mb-3">{{ company.description|linebreaks }}</p>
                    {% endif %}
                    <div class="company-stats">
                        <div class="stat-item"><i class="bi bi-calendar3"></i> Joined {{ company.created_at|date:"F Y" }}</div>
                        <span class="mx-2 separator">•</span>
                        <div class="stat-item"><i class="bi bi-box-seam"></i> {{ items.paginator.count }} Products</div>
                        {% if avg_rating %}
                        <span class="mx-2 separator">•</span>
                        <div class="stat-item"><i class="bi bi-star-fill text-warning"></i> {{ avg_rating|floatformat:1 }} / 5 ({{ reviews.count }} reviews)</div>
                        {% endif %}
                    </div>
                </div>
                {% if user == company.user %}
                <div class="mt-3 mt-md-0 ms-md-3">
                    <a href="{% url 'business:company_dashboard' %}" class="btn btn-primary" title="Dashboard">
                        <i class="bi bi-speedometer2"></i> <span class="d-none d-md-inline">Dashboard</span>
                    </a>
                </div>
                {% else %}
                <div class="mt-3 mt-md-0 ms-md-3">
                    <a href="{% url 'chat:start_chat' company.user.id %}" class="btn-company-contact me-2" title="Contact Company">
                        <i class="bi bi-chat-dots"></i> <span class="d-none d-md-inline">Contact</span>
                    </a>
                    <a href="{% url 'business:toggle_follow_company' company.id %}" class="btn-company-follow {% if is_following %}following{% endif %}" title="{% if is_following %}Unfollow{% else %}Follow{% endif %}">
                        {% if is_following %}
                            <i class="bi bi-person-check-fill"></i> <span class="d-none d-md-inline">Following</span>
                        {% else %}
                            <i class="bi bi-person-plus"></i> <span class="d-none d-md-inline">Follow</span>
                        {% endif %}
                    </a>
                    <a href="{% url 'business:report_company' company.id %}" class="btn btn-outline-danger ms-2" title="Report Company" style="padding: 0.6rem 1rem; border-radius: 0.5rem;">
                        <i class="bi bi-flag"></i> <span class="d-none d-md-inline">Report</span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Company Location Map -->
    {% if company.address %}
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="card-title mb-3">Location</h5>
            <p class="text-muted mb-3"><i class="bi bi-geo-alt-fill text-danger"></i> {{ company.address }}</p>
            <div class="ratio ratio-21x9" style="max-height: 300px;">
                <iframe src="https://maps.google.com/maps?q={{ company.address|urlencode }}&t=&z=15&ie=UTF8&iwloc=&output=embed" frameborder="0" style="border:0" allowfullscreen></iframe>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-md-6">
            <form method="get" class="d-flex">
                <input type="text" name="q" class="form-control me-2" placeholder="Search in {{ company.name }}..." value="{{ request.GET.q|default:'' }}">
                <button type="submit" class="btn btn-outline-primary"><i class="bi bi-search"></i></button>
                {% if request.GET.q %}
                    <a href="{% url 'business:view_company_profile' company.id %}" class="btn btn-outline-secondary ms-2" title="Clear Search"><i class="bi bi-x-lg"></i></a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Products Grid -->
    <h3 class="mb-4">Products from {{ company.name }}</h3>
    
    {% if items %}
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
            {% for item in items %}
            <div class="col">
                <div class="card h-100 shadow-sm border-0 item-card-hover">
                    <a href="{% url 'business:item_detail' item.id %}" class="text-decoration-none text-dark">
                        <div class="position-relative" style="padding-top: 100%; overflow: hidden;">
                            {% if item.image %}
                                <img src="{{ item.image.url }}" class="card-img-top position-absolute top-0 start-0 w-100 h-100" style="object-fit: cover;" alt="{{ item.title }}">
                            {% else %}
                                <div class="position-absolute top-0 start-0 w-100 h-100 bg-light d-flex align-items-center justify-content-center text-muted">
                                    <i class="bi bi-image fs-1"></i>
                                </div>
                            {% endif %}
                            {% if item.is_pinned %}
                                <div class="position-absolute top-0 start-0 m-2 badge bg-warning text-dark shadow-sm"><i class="bi bi-pin-angle-fill"></i> Pinned</div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title text-truncate" style="font-size: 1rem;">{{ item.title }}</h5>
                            <p class="card-text fw-bold text-primary">{{ item.price }}</p>
                            <div class="d-flex justify-content-between align-items-center small text-muted">
                                <span><i class="bi bi-geo-alt"></i> {{ item.campus_location|truncatechars:15 }}</span>
                            </div>
                        </div>
                    </a>
                    {% if user == company.user %}
                    <div class="p-2 pt-0">
                        <a href="{% url 'business:toggle_pin_item' item.id %}" class="btn btn-sm w-100 {% if item.is_pinned %}btn-secondary{% else %}btn-outline-primary{% endif %}">
                            <i class="bi bi-pin-angle{% if item.is_pinned %}-fill{% endif %}"></i> {% if item.is_pinned %}Unpin{% else %}Pin to Top{% endif %}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if items.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-5">
            <ul class="pagination justify-content-center">
                {% if items.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&laquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo;</span>
                </li>
                {% endif %}

                {% for i in items.paginator.page_range %}
                    {% if items.number == i %}
                        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ i }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if items.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-box-seam display-1 text-muted"></i>
            <p class="lead mt-3 text-muted">No products available yet.</p>
        </div>
    {% endif %}

    <!-- Reviews Section -->
    <div class="mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">Reviews & Ratings</h3>
            <form method="get" class="d-flex align-items-center">
                {% if request.GET.q %}<input type="hidden" name="q" value="{{ request.GET.q }}">{% endif %}
                {% if request.GET.page %}<input type="hidden" name="page" value="{{ request.GET.page }}">{% endif %}
                
                <select name="review_sort" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto; cursor: pointer;">
                    <option value="newest" {% if review_sort == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="oldest" {% if review_sort == 'oldest' %}selected{% endif %}>Oldest</option>
                    <option value="highest" {% if review_sort == 'highest' %}selected{% endif %}>Highest Rating</option>
                    <option value="lowest" {% if review_sort == 'lowest' %}selected{% endif %}>Lowest Rating</option>
                </select>
            </form>
        </div>
        
        {% if user.is_authenticated and user != company.user %}
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">Write a Review</h5>
                <form action="{% url 'business:add_review' company.id %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="star-rating-input mb-2">
                            <i class="bi bi-star star-icon" data-value="1"></i>
                            <i class="bi bi-star star-icon" data-value="2"></i>
                            <i class="bi bi-star star-icon" data-value="3"></i>
                            <i class="bi bi-star star-icon" data-value="4"></i>
                            <i class="bi bi-star star-icon" data-value="5"></i>
                        </div>
                        {{ review_form.rating }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comment</label>
                        {{ review_form.comment }}
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            </div>
        </div>
        {% endif %}

        {% if reviews %}
            <div class="list-group">
                {% for review in reviews %}
                <div class="list-group-item border-0 shadow-sm mb-3 rounded">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 fw-bold">{{ review.user.username }}</h6>
                        <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                    </div>
                    <div class="mb-2 text-warning">
                        {% for i in "12345"|make_list %}{% if forloop.counter <= review.rating %}<i class="bi bi-star-fill"></i>{% else %}<i class="bi bi-star"></i>{% endif %}{% endfor %}
                    </div>
                    <p class="mb-1">{{ review.comment }}</p>
                    {% if user == review.user %}
                    <div class="mt-2">
                        <a href="{% url 'business:edit_review' review.id %}" class="text-muted me-3" style="font-size: 0.9rem; text-decoration: none;"><i class="bi bi-pencil"></i> Edit</a>
                        <a href="{% url 'business:delete_review' review.id %}" class="text-danger" style="font-size: 0.9rem; text-decoration: none;" onclick="return confirm('Are you sure you want to delete this review?')"><i class="bi bi-trash"></i> Delete</a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No reviews yet.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stars = document.querySelectorAll('.star-rating-input .star-icon');
        const starContainer = document.querySelector('.star-rating-input');
        const ratingInput = document.querySelector('input[name="rating"]');
        
        if (!starContainer) return;
        
        // Initialize if value exists (e.g. on validation error)
        if (ratingInput.value) {
            updateStars(ratingInput.value);
        }

        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                ratingInput.value = value;
                updateStars(value);
            });

            star.addEventListener('mouseenter', function() {
                updateStars(this.getAttribute('data-value'));
            });
        });

        starContainer.addEventListener('mouseleave', function() {
            updateStars(ratingInput.value || 0);
        });

        function updateStars(value) {
            stars.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                const ratingValue = parseInt(value);
                if (starValue <= ratingValue) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill');
                } else {
                    star.classList.remove('bi-star-fill');
                    star.classList.add('bi-star');
                }
            });
        }
    });
</script>
{% endblock %}