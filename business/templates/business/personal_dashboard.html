{% extends "business/base.html" %}
{% load static %}

{% block title %}My Dashboard | U-Connect{% endblock %}

{% block main_class %}dashboard-full-width{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo-placeholder"><i class="bi bi-person-circle"></i></div>
            <h5 class="sidebar-company-name">{{ user.username }}</h5>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#overview" class="sidebar-link active" onclick="switchTab(event, 'overview')">
                <i class="bi bi-speedometer2"></i> <span>Overview</span>
            </a>
            <a href="#products" class="sidebar-link" onclick="switchTab(event, 'products')">
                <i class="bi bi-box-seam"></i> <span>My Items</span>
            </a>
            <a href="#comments" class="sidebar-link" onclick="switchTab(event, 'comments')">
                <i class="bi bi-chat-left-text"></i> <span>Comments</span>
            </a>
            <a href="{% url 'users:edit_profile' %}" class="sidebar-link">
                <i class="bi bi-gear"></i> <span>Account Settings</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <button id="theme-toggle-sidebar" class="theme-toggle-btn w-100 justify-content-start px-3">
                <i class="bi bi-moon"></i> <span>Toggle Theme</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Overview Tab -->
        <div id="overview" class="dashboard-tab active">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                <h2 class="dashboard-title mb-0">Dashboard Overview</h2>
                <a href="{% url 'business:post_item' %}" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Sell Item</a>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-primary-light text-primary"><i class="bi bi-box-seam"></i></div>
                    <div class="stat-info">
                        <h3>{{ total_products }}</h3>
                        <p>Total Items</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-success-light text-success"><i class="bi bi-eye"></i></div>
                    <div class="stat-info">
                        <h3>{{ total_views }}</h3>
                        <p>Total Views</p>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <div class="col-lg-8">
                    <div class="dashboard-card h-100">
                        <div class="card-header-custom">
                            <h5>Views per Category</h5>
                        </div>
                        <div class="card-body-custom">
                            <canvas id="viewsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="dashboard-card h-100">
                        <div class="card-header-custom">
                            <h5>Item Status</h5>
                        </div>
                        <div class="card-body-custom">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trending -->
            <div class="row g-4">
                <div class="col-lg-12">
                    <div class="dashboard-card">
                        <div class="card-header-custom">
                            <h5>Most Viewed Items</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Views</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in trending_items %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                {% if item.image %}
                                                <img src="{{ item.image.url }}" class="rounded" width="40" height="40" style="object-fit: cover;">
                                                {% else %}
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-image"></i></div>
                                                {% endif %}
                                                <span class="fw-bold text-truncate" style="max-width: 150px;">{{ item.title }}</span>
                                            </div>
                                        </td>
                                        <td>{{ item.views }}</td>
                                        <td>{{ item.price }}</td>
                                        <td><span class="badge bg-success">{{ item.status|title }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="dashboard-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="dashboard-title">My Items</h2>
                <a href="{% url 'business:post_item' %}" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Sell Item</a>
            </div>
            <div class="dashboard-card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Views</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>
                                    {% if item.image %}
                                    <img src="{{ item.image.url }}" class="rounded" width="50" height="50" style="object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="bi bi-image"></i></div>
                                    {% endif %}
                                </td>
                                <td class="fw-bold">{{ item.title }}</td>
                                <td>{{ item.category_obj.name }}</td>
                                <td>{{ item.price }}</td>
                                <td>{{ item.views }}</td>
                                <td>
                                    <span class="badge {% if item.status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">{{ item.status|title }}</span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{% url 'business:edit_item' item.id %}" class="btn btn-sm btn-outline-secondary" title="Edit"><i class="bi bi-pencil"></i></a>
                                        <a href="{% url 'business:delete_item' item.id %}" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Delete this item?')"><i class="bi bi-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Comments Tab -->
        <div id="comments" class="dashboard-tab">
            <h2 class="dashboard-title mb-4">Comments on My Items</h2>
            <div class="dashboard-card">
                {% if recent_comments %}
                <div class="list-group list-group-flush">
                    {% for comment in recent_comments %}
                    <div class="list-group-item p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="w-100">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">{{ comment.user.username }} <span class="text-muted fw-normal">on</span> <a href="{% url 'business:item_detail' comment.item.id %}" class="text-decoration-none">{{ comment.item.title }}</a></h6>
                                    <small class="text-muted">{{ comment.created_at|date:"M d, H:i" }}</small>
                                </div>
                                <p class="mb-1 text-muted">{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-chat-left-text fs-1"></i>
                    <p class="mt-3">No comments yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function switchTab(event, tabId) {
        event.preventDefault();
        document.querySelectorAll('.dashboard-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const viewsCtx = document.getElementById('viewsChart').getContext('2d');
        new Chart(viewsCtx, {
            type: 'bar',
            data: { labels: {{ cat_labels|safe }}, datasets: [{ label: 'Total Views', data: {{ cat_data|safe }}, backgroundColor: '#4f46e5', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: { labels: {{ status_labels|safe }}, datasets: [{ data: {{ status_data|safe }}, backgroundColor: ['#10b981', '#6b7280', '#ef4444'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    });
</script>
{% endblock %}