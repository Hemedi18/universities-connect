{% extends 'business/base.html' %}
{% load static %}

{% block title %}{{ item.title }} - U-Connect{% endblock %}

{% block content %}
<div class="container container-98">
    <div class="product-detail-container">
        <div class="product-grid">
            <!-- Image Section -->
            <div class="product-image-wrapper">
                {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.title }}" class="product-image-large">
                {% else %}
                    <div class="product-image-placeholder">
                        <span class="text-muted-span">No Image Available</span>
                    </div>
                {% endif %}

                <!-- Extra Images Thumbnails -->
                {% if item.image2 or item.image3 %}
                <div class="product-thumbnails">
                    {% if item.image %}
                        <img src="{{ item.image.url }}" class="thumbnail active">
                    {% endif %}
                    {% if item.image2 %}
                        <img src="{{ item.image2.url }}" class="thumbnail">
                    {% endif %}
                    {% if item.image3 %}
                        <img src="{{ item.image3.url }}" class="thumbnail">
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Info Section -->
            <div class="product-info">
                <h1>{{ item.title }}</h1>
                <p class="item-price item-price-large">
                    {{ item.price }}
                    {% if item.compare_at_price %}
                        <span style="text-decoration: line-through; color: var(--text-muted); font-size: 0.5em; font-weight: normal;">{{ item.compare_at_price }}</span>
                    {% endif %}
                </p>
                
                <div class="product-location">
                    <i class="bi bi-geo-alt-fill"></i>
                    <span>{{ item.campus_location }}</span>
                </div>
                
                <div class="attributes-section" style="margin-top: 1rem;">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <th scope="row">Condition</th>
                                <td>{{ item.condition|default:"N/A"|title }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Category</th>
                                <td>{{ item.category_obj.name|default:item.category|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Location</th>
                                <td>{{ item.campus_location|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Posted</th>
                                <td>{{ item.created_at|date:"M d, Y" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Stock</th>
                                <td>{{ item.stock_quantity|default:"0" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Min. Order</th>
                                <td>{{ item.minimum_order_quantity|default:"1" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">SKU</th>
                                <td>{{ item.sku|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Weight</th>
                                <td>{% if item.shipping_weight %}{{ item.shipping_weight }} kg{% else %}N/A{% endif %}</td>
                            </tr>
                            <tr>
                                <th scope="row">Dimensions</th>
                                <td>{{ item.shipping_dimensions|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Tax Class</th>
                                <td>{{ item.tax_class|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Seller</th>
                                <td>{{ item.seller.username|default:"N/A" }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Dynamic Attributes Section -->
                {% if item.attribute_values.all %}
                <div class="attributes-section">
                    <h3 class="description-title">Specifications</h3>
                    <table class="table table-striped">
                        <tbody>
                            {% for attr_val in item.attribute_values.all %}
                            <tr>
                                <th scope="row">{{ attr_val.attribute.name }}</th>
                                <td>{{ attr_val.value }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <div class="description-section">
                    <h3 class="description-title">Description</h3>
                    <p class="description-text">{{ item.description|linebreaks }}</p>
                </div>

                {% if item.company %}
                <div class="card mt-4 mb-4 shadow-sm border-0 bg-light">
                    <div class="card-body">
                        <h5 class="card-title mb-3 text-muted text-uppercase fs-6 fw-bold">Sold by Company</h5>
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                {% if item.company.logo %}
                                    <img src="{{ item.company.logo.url }}" alt="{{ item.company.name }}" class="rounded-circle border" style="width: 64px; height: 64px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center text-primary" style="width: 64px; height: 64px;">
                                        <i class="bi bi-building fs-3"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">
                                    {{ item.company.name }}
                                    {% if item.company.is_verified %}
                                        <i class="bi bi-patch-check-fill verified-badge" title="Verified Company" style="font-size: 0.9em;"></i>
                                    {% endif %}
                                </h5>
                                {% if item.company.description %}
                                    <p class="small text-muted mb-0">{{ item.company.description|linebreaksbr }}</p>
                                {% endif %}
                                <a href="{% url 'business:view_company_profile' item.company.id %}" class="btn btn-sm btn-outline-primary mt-2">View Store</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="action-buttons-container">
                    <!-- Add to Cart Button -->
                    <a href="{% url 'business:add_to_cart' item.id %}" class="btn-cart btn-action-custom" title="Add to Cart">
                        <i class="bi bi-cart-plus" style="font-size: 1.5rem;"></i>
                    </a>

                    <!-- Buy/Contact Button -->
                    {% if item.contact_method == 'email' and item.contact_email %}
                        <a href="mailto:{{ item.contact_email }}?subject=Interested in {{ item.title }}" class="btn-submit btn-action-chat" title="Email Seller">
                            <i class="bi bi-envelope" style="font-size: 1.5rem;"></i>
                        </a>
                    {% elif item.contact_method == 'phone' and item.contact_phone %}
                        <a href="tel:{{ item.contact_phone }}" class="btn-submit btn-action-chat" title="Call Seller">
                            <i class="bi bi-telephone" style="font-size: 1.5rem;"></i>
                        </a>
                    {% else %}
                        <a href="{% url 'chat:start_chat' item.seller.id %}" class="btn-submit btn-action-chat" title="Chat with Seller">
                            <i class="bi bi-chat-dots" style="font-size: 1.5rem;"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="category-section" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
            <div class="category-header mb-4">
                <h2 class="category-title">Comments & Questions</h2>
            </div>
            
            <!-- Comment Form -->
            {% if user.is_authenticated %}
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ comment_form.content }}
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Comments List -->
            <div class="comments-list">
                {% for comment in comments %}
                <div class="card mb-3 border-0 shadow-sm bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold mb-0">{{ comment.user.username }}</h6>
                            <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                        </div>
                        <p class="mb-0 text-secondary">{{ comment.content }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No comments yet. Be the first to ask!</p>
                {% endfor %}
            </div>
        </div>

        <!-- Related Products Section -->
        {% if related_items %}
        <div class="category-section" style="margin-top: 4rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
            <div class="category-header">
                <h2 class="category-title">Related Products</h2>
            </div>
            <div class="horizontal-scroll-container">
                {% for r_item in related_items %}
                    <div class="item-card">
                        <a href="{% url 'business:item_detail' r_item.id %}" class="item-link-block">
                            <img src="{{ r_item.image.url }}" alt="{{ r_item.title }}" class="item-image">
                            <div class="item-details">
                                <h3 class="item-title">{{ r_item.title }}</h3>
                                <p class="item-price">{{ r_item.price }}</p>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="{% url 'business:home' %}?category={{ item.category_obj.id }}" class="btn-outline-icon" style="font-size: 0.9rem; padding: 0.5rem 1.5rem; display: inline-flex;">
                    <span>View More</span>
                    <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}